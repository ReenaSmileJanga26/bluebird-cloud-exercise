name: Release

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy target"
        required: true
        type: choice
        options: ["dev", "prod"]
        default: "dev"

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: bluebird
  APP_NAME: sample-app

jobs:
  build_push:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: bluebird-release-build

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Compute image URI
        id: meta
        run: |
          ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          ECR_URI="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          ECR_REPO="${PROJECT_NAME}-${{ github.event.inputs.environment }}-${APP_NAME}"
          TAG="sha-${GITHUB_SHA::7}"
          IMAGE_URI="${ECR_URI}/${ECR_REPO}:${TAG}"

          echo "ECR_REPO=${ECR_REPO}" >> $GITHUB_ENV
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV
          echo "image_uri=${IMAGE_URI}" >> $GITHUB_OUTPUT

      - name: Ensure ECR repository exists
        run: |
          aws ecr describe-repositories --repository-names "${ECR_REPO}" >/dev/null 2>&1 || \
            aws ecr create-repository --repository-name "${ECR_REPO}" >/dev/null

      - name: Build image
        run: |
          docker build -t "${ECR_REPO}:ci" ./app
          docker tag "${ECR_REPO}:ci" "${IMAGE_URI}"

      - name: Trivy scan (HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_URI }}
          format: table
          exit-code: "1"
          vuln-type: "os,library"
          severity: "HIGH,CRITICAL"

      - name: Push image
        run: docker push "${IMAGE_URI}"

  deploy:
    runs-on: ubuntu-latest
    needs: [build_push]
    environment: ${{ github.event.inputs.environment }} # configure prod approvals in GitHub Environments
    defaults:
      run:
        working-directory: infrastructure
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.14.3"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          role-session-name: bluebird-release-deploy

      - name: Terraform init
        run: terraform init -upgrade

      - name: Terraform apply
        env:
          TF_VAR_environment: ${{ github.event.inputs.environment }}
          TF_VAR_project_name: ${{ env.PROJECT_NAME }}
          TF_VAR_app_image: ${{ needs.build_push.outputs.image_uri }}
          TF_VAR_app_port: "3000"
          TF_VAR_health_path: "/health"
        run: terraform apply -auto-approve

      - name: Smoke test
        run: |
          HEALTH_URL="$(terraform output -raw health_url)"
          for i in $(seq 1 30); do
            if curl -fsS "$HEALTH_URL" >/dev/null 2>&1; then
              echo "Healthy: $HEALTH_URL"
              exit 0
            fi
            sleep 10
          done
          echo "Not healthy: $HEALTH_URL"
          exit 1
